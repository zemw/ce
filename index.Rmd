---
title: "Chinese Economy Charts"
date: "August 2022"
output: ioslides_presentation
---

<!-- TODO: Blank page after Title page -->

```{r, include=FALSE}
library(tidyverse)
library(lubridate)
library(patchwork)
library(forecast)
library(csutil)
library(broom)
library(zoo)

# load data
df = parse2DF("data.m")
df$nameLocal = abbr(df$seriesName, "cd")
dfq = filter(df, frequency == "Quarterly")
dfm = filter(df, frequency == "Monthly")
tsq = grabTS(dfq, out = "ts") %>% window(start=2010)
tsm = grabTS(dfm, out = "ts") %>% window(start=2010)
colnames(tsq) = dfq$nameLocal
colnames(tsm) = dfm$nameLocal

knitr::opts_chunk$set(echo = F, warning = F, message = F)
```

<!-- # Overview -->

## Gross Demestic Product

```{r}
gdpGap = trans(log(tsq[,'GDP']), seasAdj="seats", hpFilter="cycle")
dualplot(y1 = 100*gdpGap, y2 = 4*(tsq[,'GDPIQQSA']-100), 
         lylim = c(-3,3), rylim = c(-20,20),
         ylab = "GDP Gap (HP-Filtered %)", ylab.at = 0,
         rylab = "Annualized Quarterly Growth %")
abline(h=0, col="gray")
```

## Inflation

```{r}
dualplot(tsm[,'CPI']-100, tsm[,'PPIPPI']-100, ylab = "CPI (YoY)", rylab = "PPI (YoY)")
```

## Unemployment

```{r}
newEmp = tsm[,'EUNI'] %>% 
  window(start = 2013) %>% 
  trans(unit = 1/1000, disYTD = T, naFill = "kalman", chg="ttm")
unemp = tsm[,'SURU31MC'] %>% 
  window(start=2014) %>% 
  trans(naFill = "kalman")
dualplot(newEmp, unemp, 
         ylab = "New Urban Employment (Million TTM)", 
         rylab = "Unemployment Rate (31 Major Cities)")
```

## National Debt / GDP

```{r}
tsq[, c('LRNS', 'LRNE', 'LRH')] %>%
  multiplot(screens=1:3, nc=1, col=1:3, xlab='', main='', cex.lab=0.7,
            ylab=c("Real Sectors (% GDP)", "Enterprise", "Household"))
```

<!-- # Economic Activity -->

## PMI: Manufacturing

```{r}
tsm[,grep('^PMIM', colnames(tsm))] %>% window(start=2015) %>% 
  multiplot(plot.type="m", nc=4, col=1:15, mar=c(1,4,1,1), cex.lab=0.7,
            ylim=c(40,60), main='', xlab='', ylab=c(
              "PMI", "Production", "New Order", "Export", "Backlog", 
              "Final Inv", "Purchases", "Import", "Pch.Price", "Prod.Price", 
              "Raw Inv.", "Employment", "Supp.Time", "Expectation"))
```

## PMI: Service

```{r}
tsm[,grep('^PMIS', colnames(tsm))] %>% window(start=2015) %>% 
  multiplot(plot.type="m", nc=3, col=1:6, mar=c(1,4,1,1), cex.lab=0.7,
            ylim=c(40,60), main='', xlab='', ylab=c(
              "Business Activity", "New Order", "Input Price", "
              Sales Price", "Employment", "Expectation"))
```

## PMI: Construction

```{r}
tsm[,grep('^PMIC', colnames(tsm))] %>% window(start=2015) %>% 
  multiplot(plot.type="m", nc=3, col=1:6, mar=c(1,4,1,1), cex.lab=0.7,
            ylim=c(40,60), main='', xlab='', ylab=c(
              "Business Activity", "New Order", "Input Price", "
              Sales Price", "Employment", "Expectation"))
```

## Electricity Production

```{r}
dualplot(y1 = tsm[,'EP'] %>% trans(naFill = "kalman", seasAdj = "x11"), 
         y2 = tsm[,'EP'] %>% trans(naFill = "kalman", chg = "yoy"),
         ylab = "Electricity Production (kWH Bn SA)", 
         rylab = "YoY change (%)")
```

## Freight Traffic

```{r}
dualplot(y1 = tsm[,'TFT'] %>% trans(unit = 1/1000, seasAdj = "x11"), 
         y2 = tsm[,'TFT'] %>% trans(chg="yoy"),
         ylab = "Freight Traffic (Ton Bn SA)",
         rylab = "YoY Change (%)")
```


## Retail Sales

```{r, warning=FALSE}
# some series with no missing values used as regressors
# xreg = tsm[, c('TFT', 'ICIF', 'AFNI')]
tsCG = tsm[,'RSCG'] %>% window(start=2015)
dualplot(y1 = trans(tsCG, unit=1/1000, naFill = "kalman", seasAdj = "x11"), 
         y2 = trans(tsCG, naFill = "kalman", chg='yoy'), 
         ylab = "Consumer Good Retail (RMB Tn SA)", 
         rylab = "YoY Change (%)")
```

<!-- ## Online Sales and Volume -->

## Industrial Production

```{r}
# multiPlot = function(data, meta, keyword, trimLabel=0L, caption=NULL) {
#   meta = filter(meta, str_detect(seriesName, keyword))
#   data = data[, meta$nameLocal]
#   names = substring(meta$seriesName, trimLabel)
#   colnames(data) = names
#   tidy(data) %>% 
#     ggplot(aes(x=index, y=value, col=series)) + geom_line() + 
#     scale_x_continuous(breaks = scales::pretty_breaks()) +
#     facet_wrap(.~series, scales = "free_y") +
#     labs(caption = caption)
# }
tsIP = tsm[, grep('^IP', colnames(tsm))] 
labs = c('Cement', 'Steel', 'Robot', 'Automobile', 'Lithium Battery', 
         'Refrigerator', 'Washing Mach.', 'Semiconductor', 'Television')
tsIP %>% trans(unit = 1/1000, naFill = "locf", chg = "ttm") %>% 
  multiplot(screens = 1:9, col = 1:9, nc=3, xlab=NULL, ylab=labs, 
            main='',mar=c(1,4,1,1), cex.lab=0.7)
```

<!-- # Money and Financing -->

## Money Supply M1

```{r}
tsGDP = trans(tsq[,'GDP']/4, freq = 'm', naFill = "locf", chg="ttm")
dualplot(y1 = tsm[, 'MSM1'] / tsGDP * 100,
         y2 = tsm[, 'MSM1YY'], 
         ylab = "M1 to GDP (%)", 
         rylab = "YoY Change (%)")
```

## Money Supply M2

```{r}
dualplot(y1 = tsm[, 'MSM2'] / tsGDP * 100,
         y2 = tsm[, 'MSM2YYQM'], 
         ylab = "M2 (RMB Tn SA)", 
         rylab = "YoY Change (%)")
```

## Aggregate Financing

```{r}
tsAF = tsm[, grep('^AFNI', colnames(tsm))]
#   trans(unit=1/1000, naFill = "locf", chg = "ttm")
labs = c("Total (RMB Tn TTM)", "Loan", "Entrusted", "Trust",  
         "Bill", "Bond", "GovBond", "Equity", "Other")
tsAF %>% trans(unit = 1/1000, naFill = "locf", chg = "ttm") %>% 
  multiplot(screens = 1:9, col = 1:9, nc=3, xlab=NULL, ylab=labs, 
            main='',mar=c(1,4,1,1), cex.lab=0.7)
```

## Bank Loans

```{r}
tsLN = tsm[, grep('^LNI', colnames(tsm))] %>% trans(unit=1/1000, chg="ttm")
multiplot(tsLN, screens=c(1,1,2,2,2), nc=2, col=c(1,2,1,3,2), 
          xlab='', main='', ylab=c("Household (RMB Tn TTM)", "Corporate"))
```

## Interest Rates

```{r}
dualplot(tsm[, 'LPRLPR1Y'], tsm[,'IBCRRWAR0077D'], 
         ylab = "1-Year Loan Prime Rate", 
         rylab = "7-Day Interbank Repo Rate")
```

## Treasury Yields

```{r}
tsm[, grep('TBYISY', colnames(tsm))] %>% 
  multiplot(screens=1, col=1:3, xlab='', ylab='Spot Yield (%)')
legend('topleft', legend=c("1 Year", "5 Year", "10 Year"), col=1:3, lwd=2, bty="n")
```

<!-- # Business -->

## Industrial Enterprises

```{r}
tsIND = tsm[,c('IESR', 'IETP')] %>% 
  trans(unit=1/1000, disYTD=T, naFill="locf", chg="ttm")
tsIND = cbind(tsIND, tsm[,'IEI']/tsIND[,'IESR']/1000)  
tsIND = cbind(tsIND, trans(tsq[,'ICUR'], freq='m', naFill='locf'))
colnames(tsIND) = c("Rev. (RMB Tn TTM)", "Profit", "Inv. / Rev.", 'Cap. Util.')
multiplot(tsIND, screens=1:4, nc=2, col=1:4, xlab='', main='')
```

<!-- ## Industrial value-added -->

## Investments

```{r}
tsFAI = tsm[,'FAI'] %>% 
  trans(unit=1/10^6, disYTD=T, naFill="kalman", seasAdj="seats")
dualplot(tsFAI, 12*tsm[,'FAIMMSA'], rylim=c(-30,30), 
         ylab="FAI (RMB Tn SA)", rylab="Growth (Annualized MoM %)")
```

## Foreign Investment

```{r}
dualplot(y1 = trans(unit=1/1000, tsm[,'FDIU'], disYTD=T, seasAdj='x11'), 
         y2 = trans(tsm[,'FDIU'], disYTD=T, chg="yoy"), 
         ylab = "FDI (RMB Bn SA)", rylab = "YoY Change (%)")
```

<!-- # Housing  -->

## Real Estate Investment

```{r}
dualplot(y1 = trans(tsm[,'REI'], unit=1/10^6, disYTD=T, naFill="locf", chg="ttm"), 
         y2 = trans(tsm[,'REI'], chg="yoy"),
         ylab = "Real Estate Inv (RMB Tn TTM)", 
         rylab = "YTD Change (%)")
```

## Buildings Sold

```{r}
dualplot(y1 = trans(tsm[,'BS'], unit=1/10^6, disYTD=T, naFill="locf", chg="ttm"), 
         y2 = trans(tsm[,'BS'], chg="yoy"),
         ylab = "Buildings Sold (RMB Tn TTM)", 
         rylab = "YTD Change (%)")
```

## Real Estate: Floor Spaces

```{r, warning=F}
tsFSS = tsm[, c('FSS','FSSCBCB', 'FSCCBCB', 'FSCCBCB.')] %>% 
  trans(unit=1/10^6, disYTD=T, naFill="locf", chg="ttm")
colnames(tsFSS) = c("Sold (Sqm Bn TTM)", "Started", "Construction", "Completed")
multiplot(tsFSS, screens=1:4, nc=2, col=1:4, xlab='', main='',cex.lab=0.8)
```

## Government Revenue and Expenditure

```{r}
tsm[,c('GR', 'GE')] %>% 
  trans(unit=1/1000, disYTD=T, naFill="locf", chg="ttm") %>% 
  multiplot(plot.type='s', col=1:2, xlab='', main='', 
            ylab=c('Govt Rev. vs Exp. (RMB Tn TTM)'))
```

## Local Government Debt

```{r}
tsm[, grep('LGDI', colnames(tsm))] %>% 
  window(start=2018) %>% 
  trans(unit=1/10^6, chg="ttm") %>% 
  multiplot(plot.type="m", nc=2, col=1:4, xlab='', main='', cex.lab=0.8,
    ylab=c("General (RMB Tn TTM)", "Special", "New Issued", "Refinance"))
```

## Trade Balance

```{r}
tsm[, c('ICIF', 'EFOB', 'TB')] %>% 
  trans(unit=1/1000, seasAdj = "x11") %>% 
  multiplot(screens=c(1,1,2), nc=2, col=1:3, xlab='', main='',
            ylab=c("Import vs Export (USD Bn SA)", "Trade Balance"))
```

## Exchange Rate

```{r}
dualplot(y1 = tsm[,'TB'] %>% trans(unit=1/1000, seasAdj="x11"), 
         y2 = 1/tsm[,'FXRPBOCMERMBUSD'], 
         ylab = "Trade Balance (USD Bn SA)", 
         rylab = "CNY / USD")
```


## Balance of Payments

```{r}
tidy(tsq[, grep('^BP', colnames(tsq))]) %>% 
  mutate(series = factor(
    series, 
    levels = c("BPFARA","BPCACA","BPFAN","BPNEO"), 
    labels = c("Reserve","C.A.","F.A.","Errors"))
  ) %>% 
  replace_na(list(value=0)) %>% 
  ggplot(aes(index, value/1000, fill=series)) +
  geom_col(position = "stack") +
  scale_fill_manual(values=2:5) +
  scale_x_continuous(breaks = scales::pretty_breaks()) +
  labs(x = NULL, y = "BoP (Quarterly USD Bn)", fill=NULL, 
       caption= str_glue(
       "Net Export: CR+; FDI Inflow: CR+; Forex Receipt: DR-;Reserve Accu.: DR-. Disguised capital outflow:\ 
       1. Export wihtout cash receipt (Errors--); 2. Hide export or exaggerate import (shrinked C.A.)\
       3. Hided oversea investment (F.A.++Errors--). 4. Underground forex exchange (no record)"))+
  theme_classic() 
```

## RMB Assets Hold by Foreign Entities

```{r}
tsm[, grep('DRMBFAHOE', colnames(tsm))] %>% window(start=2014) %>% 
  multiplot(screens=1:4, nc=2, col=1:4, main='',xlab='',
            ylab = c("Equity (RMB Bn)", "Bond", "Loan", "Deposit"))
```

## Equity Market

```{r}
tsm[, grep('ICSI300', colnames(tsm))] %>% window(start=2020) %>% 
multiplot(plot.type="m", nc=4, col=1:12, mar=c(1,4,1,1), main='', xlab='', 
          ylab=c("CSI 300", "Energy", "Material", "Industrial", "Cons. Disc.", 
                 "Cons. Stap.", "Health Care", "Financial", "InfoTech", 
                 "Telecom", "Utilities"), cex.lab=0.7)
```

## Commodity Market

```{r}
tsm[, grep('^SP', colnames(tsm))] %>% window(start=2020) %>% 
multiplot(plot.type="m", nc=3, col=1:7, mar=c(1,4,1,1), main='', xlab='',
          ylab=c("Copper", "Steel Rebar", "Iron Ore", "Coke", "Rubber", "Soybean", "Cotton"))
```

## Bond Market

```{r}
tsm[, grep("BOPBC", colnames(tsm))] %>% 
  window(start=2015) %>% trans(unit=1/10^6) %>% 
  multiplot(plot.type="s", col=1:3, main='', xlab='', ylab="Bond Outstanding (RMB Tn)")
legend('topleft', legend=c("Gov", "Fin", "Corp"), col=1:3, lwd=2)
```

## Bond Market

```{r}
tsm[, grep("BIPBC", colnames(tsm))] %>% 
  window(start=2015) %>% trans(unit=1/10^6) %>% 
  multiplot(plot.type="s", col=1:3, main='', xlab='', ylab="Bond Issuance (RMB Tn)")
legend('topleft', legend=c("Gov", "Fin", "Corp"), col=1:3, lwd=2)
```

<!-- THE END -->
